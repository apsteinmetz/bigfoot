---
title: "Bigfoot Sightings"
output: html_notebook
---
load BFRO sighting report from Kaggle dataset
```{r}
library(tidyverse)
library(broom)
library(lubridate)
library(ggplot2)
library(ggmap)
#library(sp)
library(maps)
library(mapproj)
library(rgdal)


```

```{r}

states_map_48 <- as_data_frame(map_data("state")) %>% select(-subregion)
states_map_48_nested<-states_map_48 %>% 
  ungroup() %>% 
  transmute(state=as.factor(region),
            longitude=long,
            latitude=lat)%>%
  group_by(state) %>% 
  nest()

# files from https://www.census.gov/geo/maps-data/data/cbf/cbf_counties.html put in gis directory
states_map_50<-readOGR(dsn="gis",layer="cb_2016_us_state_20m")


states_map_50_nested<-tidy(states_map_50) %>% 
  as_data_frame() %>% 
  transmute(id=as.factor(id),
            longitude=long,
            latitude=lat)%>%
  group_by(id) %>% 
  nest() %>% 
  bind_cols(state=states_map_50$NAME) %>% 
  group_by(state)
  
  
```
```{r}

bfro_data<-read_csv("bfro-report-locations.csv")
bfro_data<-bfro_data %>% mutate(state=as.character(NA))

geo_data <- as_data_frame(read.csv(text="ID,      longitude,      latitude
30531, -76.04183, 39.73523
24544, -88.99630, 37.28900
31153, -81.43248, 28.98491"
))
geo_data<-geo_data %>% mutate(state=as.character(NA))
```

```{r}
for (st in states_map_50_nested$state){
  poly.x<-states_map_50_nested %>% filter(state==st) %>% .$data %>% .[[1]] %>% .$longitude
  poly.y<-states_map_50_nested %>% filter(state==st) %>% .$data %>% .[[1]] %>% .$latitude
  state_flag<-as.logical(point.in.polygon(bfro_data$longitude,bfro_data$latitude,poly.x,poly.y))
  if (TRUE %in% state_flag){
    bfro_data[as.logical(state_flag),]$state=st
  }
  
}
bfro_data<-bfro_data %>% mutate(Year=year(timestamp))

```

```{r}
  
  getMap<-function(data,year) {
    gg<-gg %+% data[Year==year]
    title = paste("Sighting Year",n)
    #assume any year into future is cumulative sightings for all years
    if (year > year(Sys.Date())) {
      title = "All Sighting Years"
      gg <- gg + scale_fill_distiller(name="Bigfoot\nSightings", palette="Greens", na.value="#7f7f7f")
      title<- "All Sighting Years"
    }
    gg<-gg + ggtitle(title)
    gg<-gg + coord_map()
    return (gg)
  }
  
 
  sightYear<-2012
  thisYear<-year(Sys.Date())
  maxSights=max(bfro_data[Year<thisYear+1]$count)
  gg<-ggplot(bfro_data, aes(map_id = state)) + 
    geom_map(aes(fill = count), map = states_map) + 
    expand_limits(x = states_map$long, y = states_map$lat)
  gg <- gg + theme_bw()
  gg <- gg + scale_fill_distiller(name="Bigfoot\nSightings", palette="Greens", na.value="#7f7f7f",limits=c(0,maxSights))
  gg <- gg + theme(plot.title=element_text(face="bold", hjust=0, size=24))
  gg <- gg + theme(panel.border=element_blank())
  gg <- gg + theme(panel.grid=element_blank())
  gg <- gg + theme(axis.ticks=element_blank())
  gg <- gg + theme(axis.text=element_blank())
  gg<- gg + labs(x="",y="")
  gg <- gg + theme(strip.background=element_blank())
  gg <- gg+borders("state",inherit.aes=FALSE, colour = "black")
  

inputYr<-min(input$yr,thisYear-2)
fills<-c(rep("grey50",inputYr-startYear),"red",rep("grey50",thisYear-inputYr-2))
p<-ggplot(data=subsetYear)
p<-p+geom_bar(aes(x=Year,y=number),stat="identity",fill=(fills))
print(p)

```

