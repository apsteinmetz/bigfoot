---
title: "Bigfoot Sightings"
output: html_notebook
---
load BFRO sighting report from Kaggle dataset
```{r}
library(devtools)
library(tidyverse)
library(broom)
library(lubridate)
library(ggplot2)
#install_github("dkahle/ggmap")
library(ggmap)
#library(sp)
library(maps)
library(mapproj)
library(rgdal)


```

```{r}
states_map<-map_data("state")
states_map_48 <- as_data_frame(map_data("state")) %>% select(-subregion)
states_map_48_nested<-states_map_48 %>% 
  ungroup() %>% 
  transmute(state=as.factor(region),
            longitude=long,
            latitude=lat)%>%
  group_by(state) %>% 
  nest()

# files from https://www.census.gov/geo/maps-data/data/cbf/cbf_counties.html put in gis directory
states_map_50<-readOGR(dsn="gis",layer="cb_2016_us_state_20m")


states_map_50_nested<-tidy(states_map_50) %>% 
  as_data_frame() %>% 
  mutate(id=as.factor(id)) %>% 
  group_by(id) %>% 
  nest() %>% 
  bind_cols(region=states_map_50$NAME) %>% 
  group_by(region)
  
states_map_50<-states_map_50_nested %>% unnest()  %>% select(id,region,long,lat)
```
```{r}

bfro_data<-read_csv("bfro-report-locations.csv")
bfro_data<-bfro_data %>% mutate(state=as.character(NA))

geo_data <- as_data_frame(read.csv(text="ID,      longitude,      latitude
30531, -76.04183, 39.73523
24544, -88.99630, 37.28900
31153, -81.43248, 28.98491"
))
geo_data<-geo_data %>% mutate(state=as.character(NA))
```

```{r}
for (st in states_map_50_nested$state){
  poly.x<-states_map_50_nested %>% filter(state==st) %>% .$data %>% .[[1]] %>% .$longitude
  poly.y<-states_map_50_nested %>% filter(state==st) %>% .$data %>% .[[1]] %>% .$latitude
  state_flag<-as.logical(point.in.polygon(bfro_data$longitude,bfro_data$latitude,poly.x,poly.y))
  if (TRUE %in% state_flag){
    bfro_data[as.logical(state_flag),]$state=st
  }
  
}
bfro_data<-bfro_data %>% mutate(Year=year(timestamp))
state_sum<-bfro_data %>% group_by(state,Year) %>% summarise(count=n()) 

```

```{r}
  
  getMap<-function(gg,data,year=0) {
    #assume any year into future is cumulative sightings for all years
    if (year==0 | year > year(Sys.Date())) {
      gg<-gg %+% data
      title = "All Sighting Years"
      gg <- gg + scale_fill_distiller(name="Bigfoot\nSightings", palette="Greens", na.value="#7f7f7f")
      title<- "All Sighting Years"
    }
    else {
      gg<-gg %+% filter(data,Year==year)
      title = paste("Sighting Year",n)
    }
    gg<-gg + ggtitle(title)
    gg<-gg + coord_map()
    return (gg)
  }
  

ggplot()+geom_map(data=states_map_48,map=states_map_48,aes(x=long,y=lat,map_id=region),color="white",fill="grey")+coord_map()

#set up map plot defaults
  thisYear<-year(Sys.Date())
  maxSights<-state_sum %>% filter(Year<thisYear+1) %>% summarize(maxSights=max(count))
  gg<-ggplot(state_sum, aes(map_id =region)) + 
#    geom_map(data=states_map_48,aes(fill = count), map = states_map_48) + 
#    expand_limits(x = bfro_data$longitude, y = bfro_data$latitude)
#  gg<-ggplot() + 
    geom_map(data=states_map_48,map=states_map_48,aes(x=long,y=lat,map_id=region),color="white",fill="grey")+
    coord_map()
  #+
  #  expand_limits(x = bfro_data$longitude, y = bfro_data$latitude)
  gg <- gg + theme_bw()
  gg <- gg + scale_fill_distiller(name="Bigfoot\nSightings", palette="Greens", na.value="#7f7f7f",limits=c(0,maxSights))
  gg <- gg + theme(plot.title=element_text(face="bold", hjust=0, size=24))
  gg <- gg + theme(panel.border=element_blank())
  gg <- gg + theme(panel.grid=element_blank())
  gg <- gg + theme(axis.ticks=element_blank())
  gg <- gg + theme(axis.text=element_blank())
  gg<- gg + labs(x="",y="")
  gg <- gg + theme(strip.background=element_blank())
  gg <- gg+borders("state")
  
print(getMap(gg,state_sum))
#timeline of all sightings  
startYear<-1990
inputYr<-2001
fills<-c(rep("grey50",inputYr-startYear),"red",rep("grey50",thisYear-inputYr-2))
subsetYear<-state_sum %>% filter(Year==inputYr)
p<-ggplot(data=subsetYear)
p<-p+geom_bar(aes(x=Year,y=count),stat="identity",fill=(fills))
print(p)

```

